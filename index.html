<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>In-Game Screen</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#FFCC00",
            secondary: "#FF9900",
            "background-light": "#FFFBEB",
            "background-dark": "#1F1F1F",
            "surface-light": "rgba(255, 255, 255, 0.6)",
            "surface-dark": "rgba(0, 0, 0, 0.4)",
          },
          fontFamily: {
            display: ["'Noto Sans TC'", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "1rem",
            'xl': "1.5rem",
            '2xl': "2rem",
          },
          boxShadow: {
            'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
            'glow': '0 0 15px rgba(255, 204, 0, 0.5)',
          }
        },
      },
    };
  </script>
  <style>
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    .ar-duck { animation: float 3s ease-in-out infinite; }
    body::-webkit-scrollbar { display: none; }
    body { min-height: 100dvh; height: 100dvh; }
    #canvas-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "cannon-es": "https://esm.sh/cannon-es@0.20.0"
      }
    }
  </script>

  <script src="js/global_audio.js"></script>
  <script type="module">
    import * as THREE from 'three';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    import * as CANNON from 'cannon-es';

    document.addEventListener('DOMContentLoaded', () => {
      initGame();
    });

    function initGame() {
      const container = document.getElementById('canvas-container');
      if (!container) return;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
      const initialCameraPos = new THREE.Vector3(0, 100, 400);
      const targetCameraPos = initialCameraPos.clone();
      camera.position.copy(initialCameraPos);
      camera.lookAt(0, 30, 0);

      // --- AR Background Setup ---
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const video = document.createElement('video');
        video.playsInline = true;
        video.autoplay = true;
        video.muted = true;
        video.style.display = 'none';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(function (stream) {
            video.srcObject = stream;
            video.play();
            const texture = new THREE.VideoTexture(video);
            texture.colorSpace = THREE.SRGBColorSpace;
            scene.background = texture;
          })
          .catch(function (err) {
            console.error('AR Error:', err);
            scene.background = new THREE.Color(0xf0f0f0);
          });
      }

      // --- LIGHTING FIXES ---
      // 1. Hemisphere light for general sky/ground contrast
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
      hemiLight.position.set(0, 1000, 0);
      scene.add(hemiLight);

      // 2. Directional light for shadows
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
      dirLight.position.set(100, 1000, 100);
      dirLight.castShadow = true;
      scene.add(dirLight);

      // 3. ADDED: Ambient Light to fill in dark spots (This brightens the model overall)
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);

      // --- RENDERER FIXES ---
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      
      // 4. ADDED: Color Management (Prevents models looking dark/washed out)
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.2; // Adjust this higher (e.g. 1.5) if still too dark
      
      container.appendChild(renderer.domElement);

      // --- Cannon.js Physics ---
      const world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82 * 20, 0) });
      const defaultMaterial = new CANNON.Material('default');
      const defaultContactMaterial = new CANNON.ContactMaterial(defaultMaterial, defaultMaterial, {
        friction: 1000.0,
        restitution: 0.0,
      });
      world.addContactMaterial(defaultContactMaterial);

      const groundShape = new CANNON.Box(new CANNON.Vec3(50, 5, 50));
      const groundBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: groundShape, material: defaultMaterial });
      groundBody.position.set(0, -35, 0);
      world.addBody(groundBody);

      // --- Game Variables ---
      let loadedModels = [];
      let ducks = [];
      let gameOver = false;
      let isPaused = false;
      let score = 0;
      let level = 1;
      const failThreshold = -100;
      const spawnHeight = 350;
      const duckScaleTarget = 70;
      let currentDropX = 0;
      let isAiming = false;
      let startDragX = 0;
      let baseDropX = 0;
      const sensitivity = 0.4;

      // --- Audio ---
      const bgm = new Audio('music/game_music.m4a');
      bgm.loop = true;
      bgm.volume = 0.5;
      const collisionSound = new Audio('music/duck.m4a');

      // --- Guide Line ---
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 });
      const guideLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 1000, 0), new THREE.Vector3(0, -1000, 0)]), lineMaterial);
      guideLine.visible = false;
      scene.add(guideLine);

      // --- FBX LOADING ---
      const loader = new FBXLoader();
      const modelPaths = [
        'Model/cute+chick+3d+model.fbx',
        'Model/yellow+chick+toy+3d+model.fbx',
        'Model/green+chick+3d+model.fbx',
        'Model/blue+ice+chick+3d+model.fbx'
      ];

      modelPaths.forEach(path => {
        loader.load(path, function (object) {
          const box = new THREE.Box3().setFromObject(object);
          const size = box.getSize(new THREE.Vector3());
          const maxAxis = Math.max(size.x, size.y, size.z);
          const scale = duckScaleTarget / maxAxis;
          object.scale.setScalar(scale);

          const center = box.getCenter(new THREE.Vector3());
          object.position.x -= center.x * scale;
          object.position.z -= center.z * scale;
          object.position.y -= center.y * scale;
          object.position.y -= (size.y * scale) / 2;

          object.traverse(function (child) {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              
              // 5. MATERIAL FIX: Ensure textures don't look flat
              if (child.material) {
                child.material.needsUpdate = true;
              }
            }
          });
          loadedModels.push(object);
        });
      });

      function spawnDuck() {
        if (loadedModels.length === 0 || gameOver) return;
        const body = new CANNON.Body({
          mass: 1,
          material: defaultMaterial,
          shape: new CANNON.Box(new CANNON.Vec3(25, 30, 25)),
          linearDamping: 0.31,
          angularDamping: 0.5
        });

        const zoomFactor = Math.floor(score / 4);
        body.position.set(currentDropX, spawnHeight + (zoomFactor * 250), 0);
        body.quaternion.setFromEuler((Math.random() - 0.5) * 0.2, -Math.PI / 2 + (Math.random() - 0.5) * 0.2, 0);

        world.addBody(body);
        const mesh = loadedModels[Math.floor(Math.random() * loadedModels.length)].clone();
        scene.add(mesh);
        ducks.push({ mesh, body });

        score++;
        level = Math.floor(score / 4) + 1;
        document.getElementById('score-display').textContent = score;
        document.getElementById('level-display').textContent = level < 10 ? '0' + level : level;
        targetCameraPos.z = initialCameraPos.z + (zoomFactor * 300);
        targetCameraPos.y = initialCameraPos.y + (zoomFactor * 250);
      }

      // --- Control Logic ---
      function startAim(event) {
        if (gameOver || isPaused) return;
        event.preventDefault();
        isAiming = true;
        guideLine.visible = true;
        startDragX = event.touches ? event.touches[0].clientX : event.clientX;
        baseDropX = currentDropX;
      }

      function moveAim(event) {
        if (!isAiming || gameOver || isPaused) return;
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        currentDropX = Math.max(-45, Math.min(45, baseDropX + (clientX - startDragX) * sensitivity));
        guideLine.position.x = currentDropX;
      }

      function endAim() {
        if (!isAiming) return;
        isAiming = false;
        guideLine.visible = false;
        spawnDuck();
      }

      const dropBtn = document.getElementById('btn-drop');
      dropBtn.addEventListener('touchstart', startAim, { passive: false });
      window.addEventListener('touchmove', moveAim, { passive: false });
      window.addEventListener('touchend', endAim);
      dropBtn.addEventListener('mousedown', startAim);
      window.addEventListener('mousemove', moveAim);
      window.addEventListener('mouseup', endAim);

      // --- UI Events ---
      document.getElementById('btn-pause').addEventListener('click', () => { isPaused = true; document.getElementById('pause-overlay').classList.remove('hidden'); });
      document.getElementById('btn-resume').addEventListener('click', () => { isPaused = false; document.getElementById('pause-overlay').classList.add('hidden'); });
      document.getElementById('btn-reset').addEventListener('click', () => { window.location.href = 'game_countdown_screen.html'; });
      document.getElementById('btn-screenshot').addEventListener('click', () => {
        renderer.render(scene, camera);
        const link = document.createElement('a');
        link.download = `duck-score-${score}.png`;
        link.href = renderer.domElement.toDataURL('image/png');
        link.click();
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      function animate() {
        if (gameOver) return;
        requestAnimationFrame(animate);
        camera.position.lerp(targetCameraPos, 0.05);
        if (!isPaused) world.step(1/60);
        ducks.forEach(duck => {
          duck.mesh.position.copy(duck.body.position);
          duck.mesh.quaternion.copy(duck.body.quaternion);
          if (duck.body.position.y < failThreshold) {
            gameOver = true;
            window.location.href = 'game_over_results.html?score=' + score;
          }
        });
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display h-screen w-screen overflow-hidden flex flex-col relative select-none">
  <div class="absolute inset-0 z-0">
    <div id="canvas-container"></div>
  </div>
  <div id="ui-overlay" class="absolute inset-0 z-10 flex flex-col justify-between h-full p-6 safe-area-inset pointer-events-none">
    <div class="flex justify-between items-start pointer-events-auto">
      <div class="bg-surface-light dark:bg-surface-dark backdrop-blur-md border border-white/20 rounded-2xl p-3 flex flex-col items-center shadow-soft min-w-[80px]">
        <span class="text-xs text-gray-500 dark:text-gray-300 font-bold uppercase">Level</span>
        <span id="level-display" class="text-3xl font-black text-primary">01</span>
      </div>
      <div class="bg-surface-light dark:bg-surface-dark backdrop-blur-md border border-white/20 rounded-full px-6 py-2 shadow-soft mt-2">
        <span class="text-xl font-bold text-gray-800 dark:text-white">
          <span id="score-display">0</span> <span class="text-sm font-normal ml-1">層</span>
        </span>
      </div>
      <button id="btn-pause" class="bg-surface-light dark:bg-surface-dark backdrop-blur-md border border-white/20 rounded-2xl p-3 shadow-soft group z-20">
        <span class="material-icons-round text-gray-700 dark:text-white text-3xl group-hover:text-primary">pause</span>
      </button>
    </div>

    <div id="pause-overlay" class="absolute inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center pointer-events-auto">
      <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-2xl flex flex-col items-center space-y-6">
        <h2 class="text-4xl font-black text-gray-800 dark:text-white">暫停中</h2>
        <button id="btn-resume" class="bg-primary hover:bg-yellow-400 text-white font-bold py-4 px-10 rounded-xl text-xl flex items-center gap-2">
          <span class="material-icons-round text-2xl">play_arrow</span>繼續遊戲
        </button>
      </div>
    </div>

    <div class="flex-grow"></div>
    <div class="flex flex-col items-center space-y-6 pb-24 pointer-events-auto">
      <div class="bg-black/60 backdrop-blur-md px-6 py-3 rounded-full animate-bounce border border-white/10">
        <p class="text-white text-base font-bold flex items-center gap-2 text-center">
          <span class="material-icons-round text-primary text-xl">view_in_ar</span>
          滑動瞄準，放開掉落
        </p>
      </div>
      <div class="w-full flex justify-between items-end px-4">
        <button id="btn-reset" class="bg-white dark:bg-gray-800 rounded-full p-4 shadow-lg active:scale-95 border border-gray-100 dark:border-gray-700">
          <span class="material-icons-round text-gray-400 text-2xl">refresh</span>
        </button>
        <button id="btn-drop" class="relative w-20 h-20 bg-gradient-to-br from-primary to-yellow-500 rounded-full shadow-xl flex items-center justify-center border-4 border-white dark:border-gray-800">
          <span class="material-icons-round text-white text-4xl">arrow_downward</span>
        </button>
        <button id="btn-screenshot" class="bg-white dark:bg-gray-800 rounded-full p-4 shadow-lg active:scale-95 border border-gray-100 dark:border-gray-700">
          <span class="material-icons-round text-gray-800 dark:text-white text-2xl">photo_camera</span>
        </button>
      </div>
    </div>
  </div>
</body>
</html>
